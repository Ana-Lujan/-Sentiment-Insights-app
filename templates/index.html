{% extends "base.html" %}

{% block title %}Análisis Interactivo - Sentiment Insights{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="fas fa-search me-1"></i>Análisis Interactivo
</li>
{% endblock %}

{% block content %}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title mb-0"><i class="fas fa-search"></i> Análisis de Sentimiento Profesional</h2>
            </div>
            <div class="card-body">
                <form id="analysisForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="textInput" class="form-label">Ingresa comentarios (uno por línea)</label>
                        <textarea class="form-control" id="textInput" name="text_input" rows="5" placeholder="Escribe tus comentarios aquí..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">O sube un archivo (PDF, imagen, audio, video, texto)</label>
                        <div class="input-group">
                            <input class="form-control" type="file" id="fileInput" name="file_input" accept=".pdf,.docx,.xlsx,.pptx,.csv,.txt,.jpg,.jpeg,.png,.bmp,.tiff,.mp3,.wav,.flac,.m4a,.mp4,.avi,.mov,.mkv" style="display: none;">
                            <input type="text" class="form-control" id="fileDisplay" placeholder="Selecciona un archivo..." readonly>
                            <button class="btn btn-outline-secondary" type="button" id="fileSelectBtn">
                                <i class="fas fa-folder-open"></i> Seleccionar
                            </button>
                            <button class="btn btn-outline-danger" type="button" id="fileClearBtn" style="display: none;">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                        <div class="form-text">Formatos empresariales: PDF, Word (.docx), Excel (.xlsx), PowerPoint (.pptx), CSV, TXT, imágenes (OCR), audio/video (transcripción IA)</div>
                    </div>
                    <div class="mb-3">
                        <label for="urlInput" class="form-label">O ingresa una URL para extraer texto</label>
                        <input type="url" class="form-control" id="urlInput" name="url_input" placeholder="https://ejemplo.com">
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn">
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        <i class="fas fa-play"></i> Analizar y Generar Reporte
                    </button>
                </form>
            </div>
        </div>

        <!-- Progress Bar for Analysis -->
        <div class="card mt-4 shadow" id="progressCard" style="display: none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        <span id="progressTitle">Progreso del Análisis</span>
                    </h5>
                    <span class="badge bg-primary" id="progressBadge">0%</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                         role="progressbar"
                         style="width: 0%"
                         id="progressBar">
                    </div>
                </div>
                <div class="mt-2 text-muted small" id="progressStatus">Preparando análisis...</div>
            </div>
        </div>

        <!-- Centralized Alert System -->
        <div class="alert-system">
            <!-- Database status check removed - application is fully operational -->
            <div class="alert alert-info" id="statusAlert" style="display: none;">
                <i class="fas fa-info-circle me-2"></i>
                <span id="statusMessage"></span>
            </div>
        </div>

        {% if results %}
        <div class="card mt-4 shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0"><i class="fas fa-table"></i> Resultados del Análisis</h3>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearResults()">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                    <a href="/dashboard" class="btn btn-primary btn-sm">
                        <i class="fas fa-chart-bar"></i> Ver Dashboard
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Comentario</th>
                                <th>Sentimiento</th>
                                <th>Emoción</th>
                                <th>Intensidad</th>
                                <th>Confianza</th>
                                <th>Análisis Profesional</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td>{{ result.comentario }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if result.sentimiento == 'POSITIVO' else 'danger' if result.sentimiento == 'NEGATIVO' else 'secondary' }}">
                                        {{ result.sentimiento }}
                                    </span>
                                </td>
                                <td>{{ result.emocion }}</td>
                                <td>{{ "%.2f"|format(result.intensidad) }}</td>
                                <td>{{ "%.2f"|format(result.confianza) }}</td>
                                <td>
                                    <div class="explanation-cell">
                                        <small class="text-muted explanation-text">{{ result.explicacion[:100] }}{% if result.explicacion|length > 100 %}...{% endif %}</small>
                                        {% if result.explicacion|length > 100 %}
                                        <button class="btn btn-sm btn-outline-info ms-2" onclick="showFullExplanation('{{ result.comentario|replace("'", "\\'") }}', '{{ result.explicacion|replace("'", "\\'") }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if pdf_file %}
                <div class="mt-3">
                    <a href="{{ url_for('download_pdf', filename=pdf_file) }}" class="btn btn-outline-primary">
                        <i class="fas fa-download"></i> Descargar Reporte PDF
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Professional Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
        <div class="loading-text">
            <h4>Procesando Análisis</h4>
            <p id="loadingMessage">Extrayendo datos...</p>
        </div>
    </div>
</div>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loading-content {
    text-align: center;
    color: white;
}

.loading-spinner .spinner-border {
    width: 4rem;
    height: 4rem;
    border-width: 0.3em;
}

.loading-text h4 {
    margin-top: 1rem;
    font-weight: 600;
}

.loading-text p {
    margin-bottom: 0;
    opacity: 0.8;
}

.explanation-cell {
    max-width: 300px;
}

.explanation-text {
    display: inline;
    line-height: 1.4;
}

.explanation-cell .btn {
    padding: 0.125rem 0.25rem;
    font-size: 0.75rem;
    line-height: 1;
}

.modal-body .bg-light {
    border-left: 4px solid #007bff;
}

.explanation-content {
    line-height: 1.6;
    white-space: pre-line;
}
</style>

<script>
// File management functionality
const fileInput = document.getElementById('fileInput');
const fileDisplay = document.getElementById('fileDisplay');
const fileSelectBtn = document.getElementById('fileSelectBtn');
const fileClearBtn = document.getElementById('fileClearBtn');

fileSelectBtn.addEventListener('click', function() {
    fileInput.click();
});

fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        fileDisplay.value = file.name;
        fileClearBtn.style.display = 'block';
    } else {
        fileDisplay.value = '';
        fileClearBtn.style.display = 'none';
    }
});

fileClearBtn.addEventListener('click', function() {
    fileInput.value = '';
    fileDisplay.value = '';
    fileClearBtn.style.display = 'none';
});

document.getElementById('analysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const statusAlert = document.getElementById('statusAlert');
    const statusMessage = document.getElementById('statusMessage');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingMessage = document.getElementById('loadingMessage');

    // Hide any existing alerts first
    statusAlert.style.display = 'none';

    // Show professional loading overlay
    loadingOverlay.style.display = 'flex';
    loadingMessage.textContent = 'Extrayendo datos...';
    analyzeBtn.disabled = true;

    try {
        // Step 1: Data extraction
        loadingMessage.textContent = 'Extrayendo datos del contenido...';

        const response = await fetch('/analyze', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Error en el análisis');
        }

        // Step 2: Analysis
        loadingMessage.textContent = 'Analizando sentimientos con IA avanzada...';

        const result = await response.json();

        // Step 3: Report generation
        loadingMessage.textContent = 'Generando reporte profesional...';

        // Simulate final processing time for better UX
        await new Promise(resolve => setTimeout(resolve, 1000));

        if (response.ok) {
            loadingOverlay.style.display = 'none';
            statusAlert.className = 'alert alert-success';
            statusAlert.style.display = 'block';
            statusMessage.textContent = result.status;

            // Dispatch event for dashboard refresh
            window.dispatchEvent(new CustomEvent('analysisComplete'));

            // Success - reload to show results
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        loadingOverlay.style.display = 'none';
        statusAlert.className = 'alert alert-danger';
        statusAlert.style.display = 'block';
        statusMessage.textContent = error.message || 'Error en el análisis';

        // Reset button
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-play"></i> Analizar y Generar Reporte';
    }
});

function clearResults() {
    // Call server to clear results
    fetch('/clear_results', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        // Success - reload page to clear all results
        window.location.reload();
    })
    .catch(error => {
        console.error('Error clearing results:', error);
        // Even on error, reload to ensure clean state
        window.location.reload();
    });
}

function showFullExplanation(comment, explanation) {
    // Create modal for full explanation
    const modalHtml = `
        <div class="modal fade" id="explanationModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-brain text-primary me-2"></i>
                            Análisis Detallado del Resultado
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <h6 class="text-primary">
                                <i class="fas fa-quote-left me-1"></i>Texto Analizado:
                            </h6>
                            <p class="bg-light p-3 rounded">"${comment}"</p>
                        </div>
                        <div>
                            <h6 class="text-success">
                                <i class="fas fa-lightbulb me-1"></i>Análisis Profesional:
                            </h6>
                            <div class="bg-light p-3 rounded explanation-content">${explanation.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" onclick="copyExplanation('${explanation.replace(/'/g, "\\'")}')">
                            <i class="fas fa-copy me-1"></i>Copiar Análisis
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('explanationModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('explanationModal'));
    modal.show();
}

function copyExplanation(explanation) {
    navigator.clipboard.writeText(explanation).then(() => {
        // Show success feedback
        const toastHtml = `
            <div class="toast align-items-center text-white bg-success border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check me-2"></i>Análisis copiado al portapapeles
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        const toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.innerHTML = toastHtml;
        document.body.appendChild(toastContainer);

        const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
        toast.show();

        setTimeout(() => toastContainer.remove(), 3000);
    });
}
</script>
{% endblock %}